<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>React</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>

  <div id="app"></div>

<!-- CDN -->
  <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/react/15.6.1/react.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/15.6.1/react-dom.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/6.25.0/babel.min.js"></script>  -->

<!-- Oficiales -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/redux/3.7.2/redux.min.js"></script>
  <script src="https://unpkg.com/react@latest/dist/react.js"></script>
  <script src="https://unpkg.com/react-dom@latest/dist/react-dom.js"></script>
  <script src="https://unpkg.com/babel-standalone@6.15.0/babel.min.js"></script>

  <!-- <script src="app.js"></script> -->
  <!-- El file app.js esta todo documentado del ejemplo -->
  <script type="text/babel">
  // const todo = (state, action) => {
  //   switch (action.type){
  //     case 'ADD_TODO':
  //       return {
  //         id: action.id,
  //         text: action.text,
  //         completed: false
  //       };
  //     case 'TOGGLE_TODO':
  //       if(state.id !== action.id){
  //         return state;
  //       }
  //
  //       return {
  //         ...state,
  //         completed: !state.completed
  //       };
  //     default:
  //       return state;
  //   }
  // };
  //
  // const todos = (state = [], action) => {
  //   switch (action.type){
  //     case 'ADD_TODO':
  //       return [
  //         ...state,
  //         todo(undefined, action)
  //       ];
  //     case 'TOGGLE_TODO':
  //       return state.map(t => todo(t, action));
  //     default:
  //       return state;
  //   }
  // };
  //
  // const visibilityFilter = (state = 'SHOW_ALL', action) => {
  //   switch (action.type){
  //     case 'SET_VISIBILITY_FILTER':
  //       return action.filter;
  //     default:
  //       return state;
  //   }
  // };
  //
  // // Con esto podemos tener varios reducers
  // const { combineReducers } = Redux;
  // const todoApp = combineReducers({
  //   todos,
  //   visibilityFilter
  // });
  // // Creamos el stote del los reducers
  // const { createStore } = Redux;
  // const store = createStore(todoApp);
  //
  // const { Component } = React;
  //
  // const FilterLink = ({
  //   filter,
  //   children
  // }) => {
  //   return <a href='#'
  //             onClick={ e => {
  //               e.preventDefault();
  //               store.dispatch({
  //                 type: 'SET_VISIBILITY_FILTER',
  //                 filter
  //               })
  //             }}
  //           >
  //             { children }
  //         </a>
  // };
  //
  // // Con el dispatch despachamos el reducer todos
  // let nextTodoId = 0;
  // class TodoApp extends Component {
  //   render() {
  //     return (
  //       <div className='container'>
  //         <input ref={text => {
  //           this.input = text;
  //         }} />
  //         <button onClick={ () => {
  //             store.dispatch({
  //               type: 'ADD_TODO',
  //               text: this.input.value,
  //               id: nextTodoId++
  //             });
  //             this.input.value = '';
  //           }}>
  //             Add Todo
  //         </button>
  //         <ul>
  //           {this.props.todos.map(todo =>
  //             <li key={todo.id}
  //               onClick={() => {
  //                 store.dispatch({
  //                   type: 'TOGGLE_TODO',
  //                   id: todo.id
  //                 });
  //               }}
  //               style={{
  //                 textDecoration: todo.completed ? 'line-through' : 'none'
  //               }}>
  //               {todo.text}
  //             </li>
  //           )}
  //         </ul>
  //         <p>
  //           Show:
  //           { ' ' }
  //           <FilterLink filter='SHOW_ALL'>
  //             All
  //           </FilterLink>
  //           { ' ' }
  //           <FilterLink filter='SHOW_ACTIVE'>
  //             Activate
  //           </FilterLink>
  //           { ' ' }
  //           <FilterLink filter='SHOW_COMPLETED'>
  //             Completed
  //           </FilterLink>
  //         </p>
  //       </div>
  //     );
  //   }
  // }
  //
  // const render = () => {
  //   ReactDOM.render(
  //     <TodoApp todos={store.getState().todos}/>,
  //     document.getElementById('app')
  //   );
  // };
  // // Suscribimos la funcion render.
  // store.subscribe(render);
  // render();

  const todo = (state, action) => {
    switch (action.type){
      case 'ADD_TODO':
        return {
          id: action.id,
          text: action.text,
          completed: false
        };
      case 'TOGGLE_TODO':
        // !== no es igual o no es del mismo type
        // Esto se hace para verificar que es id si existe,
        // Si no es igual va dar true
        if(state.id !== action.id){
          return state;
        }
        // Cambiamos el completed que esta como false a true
        return {
          ...state,
          completed: !state.completed
        };
      default:
        return state;
    }
  };

  // Llamos un reducer todo para agregar el nuevo state,
  // En este reducer todos vamos guardando todos los estados anteriores
  const todos = (state = [], action) => {
    switch (action.type){
      case 'ADD_TODO':
        return [
          ...state,
          todo(undefined, action)
        ];
      case 'TOGGLE_TODO':
        return state.map(t => todo(t, action));
      default:
        return state;
    }
  };

  // Un reducer para filtrar
  const visibilityFilter = (state = 'SHOW_ALL', action) => {
    switch (action.type){
      case 'SET_VISIBILITY_FILTER':
        // console.log(action.filter)
        // Aca llega el tipo de filtro Ej: SHOW_ACTIVE
        return action.filter;
      default:
        return state;
    }
  };

  // Con esto podemos tener varios reducers
  const { combineReducers } = Redux;
  const todoApp = combineReducers({
    todos,
    visibilityFilter
  });
  // Creamos el stote del los reducers
  const { createStore } = Redux;
  const store = createStore(todoApp);

  const { Component } = React;

  // Un Component basado en function resivimos los props directamente
  const FilterLink = ({
    filter,
    currentFilter,
    children
  }) => {
    // Validamos que el filter que me llega es el mismo que currentFilter
    // Si es as√≠ enviamos es un span en vez de un <a>.
    if(filter === currentFilter){
      return <span>{children}</span>
    }
    return <a href='#'
              onClick={ e => {
                e.preventDefault();
                store.dispatch({
                  type: 'SET_VISIBILITY_FILTER',
                  filter
                })
              }}
            >
              { children }
          </a>
  };

  // Pasando a components
  const Todo = ({
    onClick,
    completed,
    text
  }) => (
    <li
      onClick={onClick}
      style={{
        textDecoration: completed ? 'line-through' : 'none'
      }}>
      {text}
    </li>
  );

  // Otro component llamando al component <Todo />
  const TodoList = ({todos, onTodoClick}) => (
    <ul>
      {todos.map(todo =>
        <Todo
          key={todo.id}
          {...todo}
          onClick={() => onTodoClick(todo.id)}
        />
      )}
    </ul>
  )

  // Un reducer donde manejamos los types de filters
  const getVisibleTodos = (todos, filter) => {
    switch (filter){
      case 'SHOW_ALL':
        return todos;
      case 'SHOW_COMPLETED':
        // Este filter es una function propia de JavaScript
        // Entonces donde t.completed sea true
        return todos.filter(t => t.completed);
      case 'SHOW_ACTIVE':
        // Aca es lo mismo si es true lo cambia a false entonces ese no es Activate
        return todos.filter(t => !t.completed);
    }
  }

  // Con el dispatch despachamos el reducer todos
  let nextTodoId = 0;
  class TodoApp extends Component {
    render() {
      const {
        todos,
        visibilityFilter
      } = this.props; // Recibimos los props
      const visibleTodos = getVisibleTodos(
        todos,
        visibilityFilter
      );
      return (
        <div className='container'>
          <input ref={text => {
            this.input = text;
          }} />
          <button onClick={ () => {
              store.dispatch({
                type: 'ADD_TODO',
                text: this.input.value,
                id: nextTodoId++
              });
              this.input.value = '';
            }}>
              Add Todo
          </button>
          <TodoList
            todos={visibleTodos}
            onTodoClick={id =>
              store.dispatch({
                type: 'TOGGLE_TODO',
                id
              })
            }
          />
          {/* Con el { ' ' } dejamos un espacio al lado. */}
          <p>
            Show:
            { ', ' }
            <FilterLink filter='SHOW_ALL' currentFilter={visibilityFilter}>
              All
            </FilterLink>
            { ', ' }
            <FilterLink filter='SHOW_ACTIVE' currentFilter={visibilityFilter}>
              Activate
            </FilterLink>
            { ', ' }
            <FilterLink filter='SHOW_COMPLETED' currentFilter={visibilityFilter}>
              Completed
            </FilterLink>
          </p>
        </div>
      );
    }
  }

  /*
    Nota: Cada vez que dispara el dispatch se activa o vuelve a correr
      el store.subscribe(render);
    Todo lo que venga ... todos={store.getState().todos}
    visibilityFilter={store.getState().visibilityFilter}
  */
  const render = () => {
    ReactDOM.render(
      <TodoApp {...store.getState()}/>,
      document.getElementById('app')
    );
  };
  // Suscribimos la funcion render.
  store.subscribe(render);
  render();

  </script>
</body>
</html>
